<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Craby Voice Chat ðŸ¦€</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      padding: 20px;
    }
    
    .container {
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #8892b0;
      margin-bottom: 30px;
    }
    
    .status {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 20px;
      margin-bottom: 30px;
      font-size: 0.9rem;
    }
    
    .status.connected { color: #64ffda; }
    .status.disconnected { color: #ff6b6b; }
    .status.processing { color: #ffd93d; }
    
    .talk-button {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(145deg, #e74c3c, #c0392b);
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 30px;
    }
    
    .talk-button:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 40px rgba(231, 76, 60, 0.5);
    }
    
    .talk-button:active,
    .talk-button.recording {
      transform: scale(0.95);
      background: linear-gradient(145deg, #27ae60, #2ecc71);
      box-shadow: 0 5px 20px rgba(46, 204, 113, 0.5);
    }
    
    .talk-button:disabled {
      background: #555;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .transcript-box {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 10px;
    }
    
    .message.user {
      background: rgba(100, 255, 218, 0.1);
      border-left: 3px solid #64ffda;
    }
    
    .message.assistant {
      background: rgba(255, 107, 107, 0.1);
      border-left: 3px solid #ff6b6b;
    }
    
    .message.assistant.ack {
      background: rgba(255, 217, 61, 0.1);
      border-left: 3px solid #ffd93d;
      font-style: italic;
    }
    
    .message-label {
      font-size: 0.75rem;
      color: #8892b0;
      margin-bottom: 5px;
    }
    
    .hint {
      color: #8892b0;
      font-size: 0.85rem;
    }
    
    audio {
      display: none;
    }
    
    .speed-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .speed-btn {
      padding: 8px 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      background: transparent;
      color: #8892b0;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .speed-btn:hover {
      border-color: rgba(255,255,255,0.4);
      color: #fff;
    }
    
    .speed-btn.active {
      border-color: #64ffda;
      color: #64ffda;
      background: rgba(100, 255, 218, 0.1);
    }
    
    .speed-label {
      color: #8892b0;
      font-size: 0.75rem;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ¦€ Craby</h1>
    <p class="subtitle">Voice Chat</p>
    
    <div class="status disconnected" id="status">Connecting...</div>
    
    <button class="talk-button" id="talkBtn" disabled>
      Hold to Talk
    </button>
    
    <div class="speed-label">Playback Speed</div>
    <div class="speed-controls">
      <button class="speed-btn active" data-speed="1">1.0x</button>
      <button class="speed-btn" data-speed="1.25">1.25x</button>
      <button class="speed-btn" data-speed="1.5">1.5x</button>
    </div>
    
    <div class="transcript-box" id="transcript"></div>
    
    <p class="hint">Hold the button and speak. Release to send.</p>
  </div>
  
  <audio id="audioPlayer"></audio>
  <audio id="holdMusic" loop></audio>
  
  <script>
    const talkBtn = document.getElementById('talkBtn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');
    const audioPlayer = document.getElementById('audioPlayer');
    const holdMusic = document.getElementById('holdMusic');
    
    let ws;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioQueue = [];
    let isPlayingAudio = false;
    let playbackSpeed = 1.0;
    
    // Speed button handlers
    document.querySelectorAll('.speed-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        playbackSpeed = parseFloat(btn.dataset.speed);
        // Apply to currently playing audio if any
        audioPlayer.playbackRate = playbackSpeed;
      });
    });
    
    // Connect to WebSocket
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);
      
      ws.onopen = () => {
        setStatus('Ready', 'connected');
        talkBtn.disabled = false;
      };
      
      ws.onclose = () => {
        setStatus('Disconnected - Reconnecting...', 'disconnected');
        talkBtn.disabled = true;
        setTimeout(connect, 2000);
      };
      
      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
      };
      
      ws.onmessage = async (event) => {
        if (event.data instanceof Blob) {
          // Audio response - queue it
          const audioUrl = URL.createObjectURL(event.data);
          audioQueue.push(audioUrl);
          playNextAudio();
        } else {
          // JSON message
          const msg = JSON.parse(event.data);
          
          if (msg.type === 'status') {
            setStatus(msg.message, 'processing');
          } else if (msg.type === 'transcript') {
            addMessage('You', msg.text, 'user');
          } else if (msg.type === 'acknowledgment') {
            // Quick acknowledgment before main response
            addMessage('Craby', msg.text, 'assistant ack');
          } else if (msg.type === 'response') {
            addMessage('Craby', msg.text, 'assistant');
          } else if (msg.type === 'hold_music') {
            if (msg.action === 'start') {
              holdMusic.src = msg.url;
              holdMusic.volume = 0.3; // Soft background volume
              // Wait for acknowledgment audio to finish, then start music
              setTimeout(() => {
                if (holdMusic.paused && holdMusic.src) {
                  holdMusic.play().catch(() => {});
                  setStatus('ðŸŽµ Hold music...', 'processing');
                }
              }, 2500); // Give time for ack TTS to play
            } else if (msg.action === 'stop') {
              // Fade out smoothly
              const fadeOut = setInterval(() => {
                if (holdMusic.volume > 0.05) {
                  holdMusic.volume -= 0.05;
                } else {
                  clearInterval(fadeOut);
                  holdMusic.pause();
                  holdMusic.currentTime = 0;
                  holdMusic.volume = 0.3; // Reset for next time
                }
              }, 50);
            }
          } else if (msg.type === 'error') {
            setStatus('Error: ' + msg.message, 'disconnected');
            holdMusic.pause();
          }
        }
      };
    }
    
    // Play queued audio sequentially
    function playNextAudio() {
      if (isPlayingAudio || audioQueue.length === 0) return;
      
      isPlayingAudio = true;
      const audioUrl = audioQueue.shift();
      
      audioPlayer.src = audioUrl;
      audioPlayer.playbackRate = playbackSpeed;
      audioPlayer.play();
      
      audioPlayer.onended = () => {
        isPlayingAudio = false;
        if (audioQueue.length === 0) {
          setStatus('Ready', 'connected');
        }
        playNextAudio();
      };
    }
    
    function setStatus(text, className) {
      statusEl.textContent = text;
      statusEl.className = 'status ' + className;
    }
    
    function addMessage(sender, text, type) {
      const div = document.createElement('div');
      div.className = 'message ' + type;
      div.innerHTML = `<div class="message-label">${sender}</div>${text}`;
      transcriptEl.appendChild(div);
      transcriptEl.scrollTop = transcriptEl.scrollHeight;
    }
    
    // Recording functions
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
          audioChunks.push(e.data);
        };
        
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          ws.send(audioBlob);
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        talkBtn.classList.add('recording');
        talkBtn.textContent = 'ðŸŽ¤ Recording...';
        setStatus('Listening...', 'processing');
      } catch (err) {
        console.error('Microphone error:', err);
        setStatus('Microphone access denied', 'disconnected');
      }
    }
    
    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        talkBtn.classList.remove('recording');
        talkBtn.textContent = 'Hold to Talk';
      }
    }
    
    // Event listeners
    talkBtn.addEventListener('mousedown', startRecording);
    talkBtn.addEventListener('mouseup', stopRecording);
    talkBtn.addEventListener('mouseleave', stopRecording);
    talkBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startRecording();
    });
    talkBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      stopRecording();
    });
    
    // Start connection
    connect();
  </script>
</body>
</html>
